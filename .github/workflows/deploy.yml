name: CI/CD Enterprise Pipeline (Clean Secrets)

on:
   push:
      branches: ["master", "staging"]

jobs:
   # --- JOB 1: ENVIRONMENT CLASSIFICATION ---
   init:
      runs-on: ubuntu-latest
      outputs:
         env_name: ${{ steps.set_env.outputs.env_name }}
      steps:
         - id: set_env
           run: |
              if [[ ${{ github.ref }} == 'refs/heads/master' ]]; then
                echo "env_name=production" >> $GITHUB_OUTPUT
              else
                echo "env_name=staging" >> $GITHUB_OUTPUT
              fi

   # --- JOB 2: BUILD & PUSH ---
   build-and-push:
      needs: init
      runs-on: ubuntu-latest
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         - name: Login to Docker Hub
           uses: docker/login-action@v3
           with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}

         - name: Build and push
           uses: docker/build-push-action@v5
           with:
              context: .
              push: true
              # Dynamic tag based on environment & build number
              tags: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ needs.init.outputs.env_name }}-${{ github.run_number }}
              cache-from: type=gha
              cache-to: type=gha,mode=max

   # --- JOB 3: DEPLOY (NO HARD-CODED LOGIC) ---
   deploy:
      needs: [init, build-and-push]
      runs-on: ubuntu-latest

      # This line is critical: It tells GitHub to load the secrets for the correct environment (prod or staging)
      environment: ${{ needs.init.outputs.env_name }}

      steps:
         - name: Deploy to EC2
           uses: appleboy/ssh-action@v1.0.3
           with:
              host: ${{ secrets.EC2_HOST }}
              username: ${{ secrets.EC2_USER }}
              key: ${{ secrets.EC2_SSH_KEY }}
              port: ${{ secrets.EC2_SSH_PORT }}
              script: |
                 # --- DECLARE VARIABLES FROM SECRETS ---
                 ENV_NAME="${{ needs.init.outputs.env_name }}"
                 IMAGE_TAG="$ENV_NAME-${{ github.run_number }}"
                 FULL_IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:$IMAGE_TAG"
                 CONTAINER_NAME="web-app-$ENV_NAME"

                 # --- GET PORT FROM ENVIRONMENT SECRET ---
                 # No need for any IF statement here
                 HOST_PORT=${{ secrets.APP_PORT }}

                 # Internal container port (should also be a secret for consistency)
                 INTERNAL_PORT=${{ secrets.CONTAINER_INTERNAL_PORT }}

                 echo "üöÄ Deploying Image: $IMAGE_TAG"
                 echo "üîå Port Mapping: $HOST_PORT:$INTERNAL_PORT"

                 # 1. Pull Image
                 docker pull $FULL_IMAGE

                 # 2. Backup
                 if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                     docker rename $CONTAINER_NAME "${CONTAINER_NAME}_backup"
                     docker stop "${CONTAINER_NAME}_backup"
                 fi

                 # 3. Create env file (Content of this file is also taken from Environment Secret)
                 echo "${{ secrets.ENV_FILE }}" > .env.$ENV_NAME

                 # 4. Run Container
                 docker run -d \
                   --name $CONTAINER_NAME \
                   -p $HOST_PORT:$INTERNAL_PORT \
                   --restart always \
                   --env-file .env.$ENV_NAME \
                   $FULL_IMAGE

                 # 5. Health Check & Rollback
                 sleep 15
                 if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                     echo "‚úÖ Success!"
                     docker rm -f "${CONTAINER_NAME}_backup" || true
                     docker image prune -a -f --filter "until=24h"
                 else
                     echo "‚ùå Failed! Rolling back..."
                     docker rm -f $CONTAINER_NAME || true
                     if [ "$(docker ps -a -q -f name=${CONTAINER_NAME}_backup)" ]; then
                         docker rename "${CONTAINER_NAME}_backup" $CONTAINER_NAME
                         docker start $CONTAINER_NAME
                     fi
                     exit 1
                 fi

         # --- EMAIL NOTIFICATION ---
         - name: Send Email Status
           if: always()
           uses: dawidd6/action-send-mail@v3
           with:
              server_address: smtp.gmail.com
              server_port: 587
              secure: false
              username: ${{ secrets.MAIL_USERNAME }}
              password: ${{ secrets.MAIL_PASSWORD }}
              subject: ${{ job.status == 'success' && '‚úÖ DEPLOY SUCCESS' || '‚ùå DEPLOY FAILED' }} - ${{ needs.init.outputs.env_name }}
              to: nvtvlog234@gmail.com
              from: GitHub Actions
              body: |
                 Environment: ${{ needs.init.outputs.env_name }}
                 Version: ${{ github.run_number }}
                 Status: ${{ job.status }}
