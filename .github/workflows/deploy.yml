name: Production Deployment (Traefik Integration)

on:
   push:
      branches: ["master"] # Ch·ªâ ch·∫°y khi push code v√†o nh√°nh master

jobs:
   # --- GIAI ƒêO·∫†N 1: BUILD & PUSH ---
   build-and-push:
      runs-on: ubuntu-latest
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         - name: Login to Docker Hub
           uses: docker/login-action@v3
           with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}

         - name: Build and push
           uses: docker/build-push-action@v5
           with:
              context: .
              push: true
              # ƒê·∫∑t t√™n theo s·ªë th·ª© t·ª± (V√≠ d·ª•: app-bavu:55) ƒë·ªÉ d·ªÖ Rollback
              tags: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ github.run_number }}
              cache-from: type=gha
              cache-to: type=gha,mode=max

   # --- GIAI ƒêO·∫†N 2: DEPLOY L√äN EC2 (V·ªöI TRAEFIK) ---
   deploy:
      needs: build-and-push
      runs-on: ubuntu-latest
      steps:
         - name: Deploy to EC2
           uses: appleboy/ssh-action@v1.0.3
           with:
              host: ${{ secrets.EC2_HOST }}
              username: ${{ secrets.EC2_USER }}
              key: ${{ secrets.EC2_SSH_KEY }}
              port: ${{ secrets.EC2_SSH_PORT }}
              script: |
                 # --- 1. THI·∫æT L·∫¨P BI·∫æN ---
                 VERSION="${{ github.run_number }}"
                 FULL_IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:$VERSION"
                 CONTAINER_NAME="web-app-production"

                 DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
                 INTERNAL_PORT="${{ secrets.CONTAINER_INTERNAL_PORT }}"

                 echo "üöÄ B·∫Øt ƒë·∫ßu Deploy Version: $VERSION"
                 echo "Pw T√™n mi·ªÅn: $DOMAIN_NAME"

                 # --- 2. K√âO IMAGE M·ªöI ---
                 docker pull $FULL_IMAGE

                 # --- 3. BACKUP CONTAINER C≈® ---
                 # N·∫øu container ƒëang ch·∫°y, ƒë·ªïi t√™n th√†nh _backup v√† d·ª´ng l·∫°i
                 if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                     echo "‚ö†Ô∏è ƒêang backup container c≈©..."
                     docker rename $CONTAINER_NAME "${CONTAINER_NAME}_backup"
                     docker stop "${CONTAINER_NAME}_backup"
                 fi

                 # --- 4. T·∫†O FILE ENV ---
                 echo "${{ secrets.ENV_FILE }}" > .env.production

                 # --- 5. CH·∫†Y CONTAINER M·ªöI (TRAEFIK MODE) ---
                 # L∆∞u √Ω: --network web_network l√† b·∫Øt bu·ªôc ƒë·ªÉ n·ªëi v·ªõi Traefik
                 docker run -d \
                   --name $CONTAINER_NAME \
                   --network web_network \
                   --restart always \
                   --env-file .env.production \
                   -l "traefik.enable=true" \
                   -l "traefik.http.routers.$CONTAINER_NAME.rule=Host(\`$DOMAIN_NAME\`)" \
                   -l "traefik.http.routers.$CONTAINER_NAME.entrypoints=websecure" \
                   -l "traefik.http.routers.$CONTAINER_NAME.tls.certresolver=myresolver" \
                   -l "traefik.http.services.$CONTAINER_NAME.loadbalancer.server.port=$INTERNAL_PORT" \
                   $FULL_IMAGE

                 # --- 6. HEALTH CHECK & ROLLBACK ---
                 echo "fz ƒêang ki·ªÉm tra s·ª©c kh·ªèe ·ª©ng d·ª•ng..."
                 sleep 15 # Ch·ªù app kh·ªüi ƒë·ªông

                 # Ki·ªÉm tra xem container c√≥ c√≤n s·ªëng kh√¥ng
                 if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                     echo "‚úÖ DEPLOY TH√ÄNH C√îNG!"
                     
                     # X√≥a backup
                     docker rm -f "${CONTAINER_NAME}_backup" || true
                     
                     # D·ªçn d·∫πp image r√°c
                     docker image prune -a -f --filter "until=24h"
                 else
                     echo "‚ùå TH·∫§T B·∫†I! Container b·ªã crash. ƒêang Rollback..."
                     
                     # X√≥a b·∫£n l·ªói
                     docker rm -f $CONTAINER_NAME || true
                     
                     # Kh√¥i ph·ª•c b·∫£n c≈©
                     if [ "$(docker ps -a -q -f name=${CONTAINER_NAME}_backup)" ]; then
                         docker rename "${CONTAINER_NAME}_backup" $CONTAINER_NAME
                         docker start $CONTAINER_NAME
                         echo "‚úÖ ƒê√£ kh√¥i ph·ª•c phi√™n b·∫£n c≈©."
                     fi
                     exit 1 # B√°o l·ªói cho GitHub Actions
                 fi

         # --- G·ª¨I MAIL TH√îNG B√ÅO ---
         - name: Send Email Status
           if: always()
           uses: dawidd6/action-send-mail@v3
           with:
              server_address: smtp.gmail.com
              server_port: 587
              secure: false
              username: ${{ secrets.MAIL_USERNAME }}
              password: ${{ secrets.MAIL_PASSWORD }}
              subject: ${{ job.status == 'success' && '‚úÖ DEPLOY SUCCESS' || '‚ùå DEPLOY FAILED' }} - ${{ github.repository }}
              to: nvtvlog234@gmail.com
              from: GitHub Actions
              body: |
                 D·ª± √°n: ${{ github.repository }}
                 ------------------------------------------
                 Phi√™n b·∫£n: ${{ github.run_number }}
                 Tr·∫°ng th√°i: ${{ job.status }}
                 T√™n mi·ªÅn: ${{ secrets.DOMAIN_NAME }}
                 Ng∆∞·ªùi commit: ${{ github.actor }}
                 Message: "${{ github.event.head_commit.message }}"
                 ------------------------------------------
                 Ki·ªÉm tra log t·∫°i: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
